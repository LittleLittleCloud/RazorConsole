@namespace RazorConsole.Components

@using System
@using Microsoft.AspNetCore.Components
@using RazorConsole.Components
@using RazorConsole.Gallery.Models
@using RazorConsole.Core.Rendering.Focus
@using Spectre.Console

@inject FocusManager FocusManager

@implements IDisposable

<Rows Expand="true">
    <Panel
        data-focusable="true"
        data-focus-key="greeting"
        Title="Greeting"
        TitleColor="@(GetTitleColor("greeting", Color.LightSteelBlue1))"
        BorderColor="@(GetBorderColor("greeting", Color.Grey93))"
        Expand="true">
        <RazorConsole.Components.Text Style="mediumspringgreen bold" Value="@GreetingTitle" />
        <RazorConsole.Components.Text Style="grey53" Value="@TimestampMessage" />
        <Grid Columns="2">
            <RazorConsole.Components.Text
                data-focusable="true"
                data-focus-key="grid-greeting-recipient-label"
                Style="@GetGridTextStyle("grid-greeting-recipient-label", "grey53 bold")"
                Value="Recipient" />
            <RazorConsole.Components.Text
                data-focusable="true"
                data-focus-key="grid-greeting-recipient-value"
                Style="@GetGridTextStyle("grid-greeting-recipient-value", "grey53")"
                Value="@DisplayName" />
            <RazorConsole.Components.Text
                data-focusable="true"
                data-focus-key="grid-greeting-date-label"
                Style="@GetGridTextStyle("grid-greeting-date-label", "grey53 bold")"
                Value="Date" />
            <RazorConsole.Components.Text
                data-focusable="true"
                data-focus-key="grid-greeting-date-value"
                Style="@GetGridTextStyle("grid-greeting-date-value", "grey53")"
                Value="@DateLabel" />
        </Grid>
    </Panel>

    <Panel
        data-focusable="true"
        data-focus-key="rows"
        Title="Rows"
        TitleColor="@(GetTitleColor("rows", Color.MediumSpringGreen))"
        BorderColor="@(GetBorderColor("rows", Color.MediumSpringGreen))">
        <Rows>
            <RazorConsole.Components.Text Style="grey53" Value="Stack sections vertically with optional spacing." />
            <Rows>
                <RazorConsole.Components.Text Style="chartreuse2" Value="• Greeting" />
                <RazorConsole.Components.Text Style="chartreuse2" Value="• Status" />
                <RazorConsole.Components.Text Style="chartreuse2" Value="• Tips" />
            </Rows>
        </Rows>
    </Panel>

    <Panel Title="Columns" TitleColor=@Color.Gold1 BorderColor=@Color.Gold1>
        <Columns>
            <RazorConsole.Components.Text Style="grey53" Value="Left" />
            <RazorConsole.Components.Text Style="grey53" Value="Right" />
        </Columns>
    </Panel>

    <Panel Title="Grid" TitleColor=@Color.Gold1 BorderColor=@Color.Gold1>
        <Grid
            Columns="3" ShowHeaders="true" Expand="true">
            <RazorConsole.Components.Text
                data-focusable="true"
                data-focus-key="grid-features-header-feature"
                Style="@GetGridTextStyle("grid-features-header-feature", "grey53 bold")"
                Value="Feature" />
            <RazorConsole.Components.Text
                data-focusable="true"
                data-focus-key="grid-features-header-description"
                Style="@GetGridTextStyle("grid-features-header-description", "grey53 bold")"
                Value="Description" />
            <RazorConsole.Components.Text
                data-focusable="true"
                data-focus-key="grid-features-header-example"
                Style="@GetGridTextStyle("grid-features-header-example", "grey53 bold")"
                Value="Example" />
            <RazorConsole.Components.Text
                data-focusable="true"
                data-focus-key="grid-features-rows-feature"
                Style="@GetGridTextStyle("grid-features-rows-feature", "grey53")"
                Value="Rows" />
            <RazorConsole.Components.Text
                data-focusable="true"
                data-focus-key="grid-features-rows-description"
                Style="@GetGridTextStyle("grid-features-rows-description", "grey53")"
                Value="Stack sections vertically with optional spacing." />
            <RazorConsole.Components.Text
                data-focusable="true"
                data-focus-key="grid-features-columns-feature"
                Style="@GetGridTextStyle("grid-features-columns-feature", "grey53")"
                Value="Columns" />
            <RazorConsole.Components.Text
                data-focusable="true"
                data-focus-key="grid-features-columns-description"
                Style="@GetGridTextStyle("grid-features-columns-description", "grey53")"
                Value="Arrange sections horizontally with balanced widths." />
            <RazorConsole.Components.Text
                data-focusable="true"
                data-focus-key="grid-features-grid-feature"
                Style="@GetGridTextStyle("grid-features-grid-feature", "grey53")"
                Value="Grid" />
            <RazorConsole.Components.Text
                data-focusable="true"
                data-focus-key="grid-features-grid-description"
                Style="@GetGridTextStyle("grid-features-grid-description", "grey53")"
                Value="Two-to-four column layout with headers and automatic width balancing." />
            <RazorConsole.Components.Text
                data-focusable="true"
                data-focus-key="grid-features-panel-feature"
                Style="@GetGridTextStyle("grid-features-panel-feature", "grey53")"
                Value="Panel" />
            <RazorConsole.Components.Text
                data-focusable="true"
                data-focus-key="grid-features-panel-description"
                Style="@GetGridTextStyle("grid-features-panel-description", "grey53")"
                Value="Titled container with optional border and accent styling." />
        </Grid>
    </Panel>

    <Panel Title="Padder" TitleColor=@Color.Plum1 BorderColor=@Color.Plum1>
        <RazorConsole.Components.Padder Padding="@(new Padding(2, 5, 60, 5))">
            <Rows>
                <RazorConsole.Components.Text Style="grey53"
                    Value="Wrap content with configurable padding on each edge." />
                <RazorConsole.Components.Text Style="mediumorchid"
                    Value="Padding (2,5,60,5) yields extra space horizontally with gentle vertical room." />
            </Rows>
        </RazorConsole.Components.Padder>
    </Panel>

    <Panel Title="Align" TitleColor=@Color.Plum1 BorderColor=@Color.Plum1>
        <Align Horizontal="HorizontalAlignment.Left" Vertical="VerticalAlignment.Top">
            <Panel Title="Left-Top" TitleColor=@Color.Plum1 BorderColor=@Color.Plum1>
                <RazorConsole.Components.Text Style="grey53" Value="Left-Top" />
            </Panel>
        </Align>
        <Align Horizontal="HorizontalAlignment.Center" Vertical="VerticalAlignment.Middle">
            <Panel Title="Center-Center" TitleColor=@Color.Plum1 BorderColor=@Color.Plum1>
                <RazorConsole.Components.Text Style="grey53" Value="Center-Center" />
            </Panel>
        </Align>
        <Align Horizontal="HorizontalAlignment.Right" Vertical="VerticalAlignment.Bottom">
            <Panel Title="Right-Bottom" TitleColor=@Color.Plum1 BorderColor=@Color.Plum1>
                <RazorConsole.Components.Text Style="grey53" Value="Right-Bottom" />
            </Panel>
        </Align>
    </Panel>

    <Panel Title="Live Status" TitleColor=@Color.Gold1 BorderColor=@Color.Gold1 Border="BoxBorder.Rounded">
        <Columns>
            <Panel Title="Activity" TitleColor=@Color.Gold1 BorderColor=@Color.Gold1>
                <Rows>
                    <Spinner Message="Awaiting your input..." Style="yellow" SpinnerType="@SpinnerType" />
                    <RazorConsole.Components.Text Style="italic" Value="Enter a name below to refresh the greeting." />
                </Rows>
            </Panel>
            <Panel Title="Next Step" TitleColor=@Color.Gold1 BorderColor=@Color.Gold1>
                <Rows>
                    <RazorConsole.Components.Text Style="grey53"
                        Value="Use Rows, Columns, and Grid to compose complex layouts quickly." />
                    <Spacer Lines="1" />
                    <RazorConsole.Components.Text Style="grey53"
                        Value="This section collapses into a stack on narrow terminals." />
                </Rows>
            </Panel>
        </Columns>
    </Panel>
</Rows>

@code {
    [Parameter]
    public required GreetingModel Model { get; set; }

    private string DisplayName => string.IsNullOrWhiteSpace(Model.Name) ? "Friend" : Model.Name;

    private string GreetingTitle => $"Hello, {DisplayName}!";

    private string DateLabel => Model.Date.ToString("dddd, MMMM d, yyyy");

    private string TimestampLabel => Model.Timestamp.ToString("HH:mm:ss");

    private string TimestampMessage => $"Now is {TimestampLabel}.";

    private bool HasTips => Model.Tips.Count > 0;

    private Spectre.Console.Spinner SpinnerType => Spectre.Console.Spinner.Known.Arc;

    protected override void OnInitialized()
    {
        FocusManager.FocusChanged += OnFocusChanged;
    }

    private void OnFocusChanged(object? sender, FocusChangedEventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    private Color GetTitleColor(string key, Color defaultColor)
        => FocusManager.IsFocused(key) ? Color.Yellow1 : defaultColor;

    private Color GetBorderColor(string key, Color defaultColor)
        => FocusManager.IsFocused(key) ? Color.Yellow1 : defaultColor;

    private string GetGridTextStyle(string key, string defaultStyle)
    {
        if (!FocusManager.IsFocused(key))
        {
            return defaultStyle;
        }

        if (string.IsNullOrWhiteSpace(defaultStyle))
        {
            return "underline";
        }

        return defaultStyle.Contains("underline", StringComparison.OrdinalIgnoreCase)
            ? defaultStyle
            : $"{defaultStyle} underline";
    }

    public void Dispose()
    {
        FocusManager.FocusChanged -= OnFocusChanged;
    }
}