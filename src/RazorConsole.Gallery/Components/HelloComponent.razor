@namespace RazorConsole.Components

@using System
@using Microsoft.AspNetCore.Components
@using RazorConsole.Components
@using RazorConsole.Core
@using RazorConsole.Core.Rendering
@using RazorConsole.Gallery.Models
@using RazorConsole.Core.Rendering.Focus
@using Spectre.Console

@inject FocusManager FocusManager
@inject LiveDisplayContextAccessor LiveDisplayContextAccessor
@implements IDisposable

<Rows Expand="true">
    <Panel data-focusable="true" data-focus-key="greeting" Title="Greeting"
        TitleColor="@(GetTitleColor("greeting", Color.LightSteelBlue1))"
        BorderColor="@(GetBorderColor("greeting", Color.Grey93))" Expand="@GreetingPanelExpanded">
        <RazorConsole.Components.Text Style="mediumspringgreen bold" Value="@GreetingTitle" />
        <RazorConsole.Components.Text Style="grey53" Value="@TimestampMessage" />
        <Grid Columns="2">
            <RazorConsole.Components.Text Value="Recipient" />
            <RazorConsole.Components.Text Value="@DisplayName" />
            <RazorConsole.Components.Text Value="Date" />
            <RazorConsole.Components.Text Value="@DateLabel" />
        </Grid>
    </Panel>

    <Panel data-focusable="true" data-focus-key="rows" Title="Rows"
        TitleColor="@(GetTitleColor("rows", Color.MediumSpringGreen))"
        BorderColor="@(GetBorderColor("rows", Color.MediumSpringGreen))">
        <Rows>
            <RazorConsole.Components.Text Style="grey53" Value="Stack sections vertically with optional spacing." />
            <Rows>
                <RazorConsole.Components.Text Style="chartreuse2" Value="• Greeting" />
                <RazorConsole.Components.Text Style="chartreuse2" Value="• Status" />
                <RazorConsole.Components.Text Style="chartreuse2" Value="• Tips" />
            </Rows>
        </Rows>
    </Panel>

    <Panel Title="Columns" TitleColor=@Color.Gold1 BorderColor=@Color.Gold1>
        <Columns>
            <RazorConsole.Components.Text Style="grey53" Value="Left" />
            <RazorConsole.Components.Text Style="grey53" Value="Right" />
        </Columns>
    </Panel>

    <Panel Title="Grid" TitleColor=@Color.Gold1 BorderColor=@Color.Gold1>
        <Grid Columns="3" ShowHeaders="true" Expand="true">
            <RazorConsole.Components.Text Value="Feature" />
            <RazorConsole.Components.Text Value="Description" />
            <RazorConsole.Components.Text Value="Example" />
            <RazorConsole.Components.Text Value="Rows" />
            <RazorConsole.Components.Text Value="Stack sections vertically with optional spacing." />
            <RazorConsole.Components.Text Value="Columns" />
            <RazorConsole.Components.Text Value="Arrange sections horizontally with balanced widths." />
            <RazorConsole.Components.Text Value="Grid" />
            <RazorConsole.Components.Text
                Value="Two-to-four column layout with headers and automatic width balancing." />
            <RazorConsole.Components.Text Value="Panel" />
            <RazorConsole.Components.Text Value="Titled container with optional border and accent styling." />
        </Grid>
    </Panel>

    <Panel Title="Padder" TitleColor=@Color.Plum1 BorderColor=@Color.Plum1>
        <RazorConsole.Components.Padder Padding="@(new Padding(2, 5, 60, 5))">
            <Rows>
                <RazorConsole.Components.Text Style="grey53"
                    Value="Wrap content with configurable padding on each edge." />
                <RazorConsole.Components.Text Style="mediumorchid"
                    Value="Padding (2,5,60,5) yields extra space horizontally with gentle vertical room." />
            </Rows>
        </RazorConsole.Components.Padder>
    </Panel>

    <Panel Title="Align" TitleColor=@Color.Plum1 BorderColor=@Color.Plum1>
        <Align Horizontal="HorizontalAlignment.Left" Vertical="VerticalAlignment.Top">
            <Panel Title="Left-Top" TitleColor=@Color.Plum1 BorderColor=@Color.Plum1>
                <RazorConsole.Components.Text Style="grey53" Value="Left-Top" />
            </Panel>
        </Align>
        <Align Horizontal="HorizontalAlignment.Center" Vertical="VerticalAlignment.Middle">
            <Panel Title="Center-Center" TitleColor=@Color.Plum1 BorderColor=@Color.Plum1>
                <RazorConsole.Components.Text Style="grey53" Value="Center-Center" />
            </Panel>
        </Align>
        <Align Horizontal="HorizontalAlignment.Right" Vertical="VerticalAlignment.Bottom">
            <Panel Title="Right-Bottom" TitleColor=@Color.Plum1 BorderColor=@Color.Plum1>
                <RazorConsole.Components.Text Style="grey53" Value="Right-Bottom" />
            </Panel>
        </Align>
    </Panel>

    <Panel Title="Live Status" TitleColor=@Color.Gold1 BorderColor=@Color.Gold1 Border="BoxBorder.Rounded">
        <Columns>
            <Panel Title="Activity" TitleColor=@Color.Gold1 BorderColor=@Color.Gold1>
                <Rows>
                    <Spinner Message="Awaiting your input..." Style="yellow" SpinnerType="@SpinnerType" />
                    <RazorConsole.Components.Text Style="italic" Value="Enter a name below to refresh the greeting." />
                </Rows>
            </Panel>
            <Panel Title="Next Step" TitleColor=@Color.Gold1 BorderColor=@Color.Gold1>
                <Rows>
                    <RazorConsole.Components.Text Style="grey53"
                        Value="Use Rows, Columns, and Grid to compose complex layouts quickly." />
                    <Spacer Lines="1" />
                    <RazorConsole.Components.Text Style="grey53"
                        Value="This section collapses into a stack on narrow terminals." />
                </Rows>
            </Panel>
        </Columns>
    </Panel>

    <Panel Title="Buttons" TitleColor=@Color.Plum1 BorderColor=@Color.Plum1>
        <Columns>
            <Button FocusKey="button-neutral" Label="@GetFocusedButtonLabel("button-neutral", "Neutral")"
                Variant="@ButtonVariant.Neutral" />
            <Button FocusKey="button-primary" Label="@GetFocusedButtonLabel("button-primary", "Primary")"
                Variant="@ButtonVariant.Primary" />
            <Button FocusKey="button-success" Label="@GetFocusedButtonLabel("button-success", "Success")"
                Variant="@ButtonVariant.Success" />
            <Button FocusKey="button-warning" Label="@GetFocusedButtonLabel("button-warning", "Warning")"
                Variant="@ButtonVariant.Warning" />
            <Button FocusKey="button-danger" Label="@GetFocusedButtonLabel("button-danger", "Danger")"
                Variant="@ButtonVariant.Danger" />
        </Columns>
    </Panel>
</Rows>

@code {
    [Parameter]
    public required GreetingModel Model { get; set; }

    private string DisplayName => string.IsNullOrWhiteSpace(Model.Name) ? "Friend" : Model.Name;

    private string GreetingTitle => $"Hello, {DisplayName}!";

    private string DateLabel => Model.Date.ToString("dddd, MMMM d, yyyy");

    private string TimestampLabel => Model.Timestamp.ToString("HH:mm:ss");

    private string TimestampMessage => $"Now is {TimestampLabel}.";

    private bool HasTips => Model.Tips.Count > 0;

    private bool GreetingPanelExpanded { get; set; } = true;

    private Spectre.Console.Spinner SpinnerType => Spectre.Console.Spinner.Known.Arc;

    private CancellationTokenSource? _refreshLoopCts;

    private Task? _refreshLoopTask = null;

    protected override async Task OnInitializedAsync()
    {
        _refreshLoopCts = new CancellationTokenSource();
        _refreshLoopTask = Task.Run(async () =>
        {
            while (!_refreshLoopCts!.IsCancellationRequested)
            {
                await Task.Delay(1000).ConfigureAwait(false);
                Model.Timestamp = DateTime.Now;
                await LiveDisplayContextAccessor.UpdateModelAsync((object?)null, CancellationToken.None).ConfigureAwait(false);
            }
        });
    }

    private Color GetTitleColor(string key, Color defaultColor)
    => FocusManager.IsFocused(key) ? Color.Yellow1 : defaultColor;

    private Color GetBorderColor(string key, Color defaultColor)
    => FocusManager.IsFocused(key) ? Color.Yellow1 : defaultColor;

    private string GetFocusedButtonLabel(string key, string defaultLabel)
    => FocusManager.IsFocused(key) ? $">{defaultLabel}<" : $" {defaultLabel} ";

    private string GetGridTextStyle(string key, string defaultStyle)
    {
        if (!FocusManager.IsFocused(key))
        {
            return defaultStyle;
        }

        if (string.IsNullOrWhiteSpace(defaultStyle))
        {
            return "underline";
        }

        return defaultStyle.Contains("underline", StringComparison.OrdinalIgnoreCase)
        ? defaultStyle
        : $"{defaultStyle} underline";
    }

    private async Task OnGreetingPanelEntered()
    {
        GreetingPanelExpanded = !GreetingPanelExpanded;
    }

    public void Dispose()
    {
        _refreshLoopCts?.Cancel();
        _refreshLoopCts?.Dispose();
        _refreshLoopCts = null;

        _refreshLoopTask = null;
    }
}