@using Microsoft.JSInterop
@inject IJSRuntime JS
@implements IDisposable

@code {
    [Parameter]
    public string? TerminalId { get; set; }

    [Parameter]
    public string? ComponentId { get; set; }

    private const string DefaultComponentKey = "align";
    private RazorConsoleRenderer<Align1>? _renderer;
    private DotNetObjectReference<AlignDemo>? _dotnetHelper;
    private bool _initialized;

    private string EffectiveTerminalId =>
        string.IsNullOrWhiteSpace(TerminalId)
            ? $"component-terminal-{(ComponentId ?? DefaultComponentKey).ToLowerInvariant()}"
            : TerminalId!;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _initialized)
        {
            return;
        }

        await InitializeAsync().ConfigureAwait(false);
    }

    private async Task InitializeAsync()
    {
        var targetId = EffectiveTerminalId;
        if (string.IsNullOrWhiteSpace(targetId))
        {
            return;
        }

        _renderer = new RazorConsoleRenderer<Align1>(targetId);
        _renderer.SnapshotRendered += HandleSnapshotRendered;

        _dotnetHelper = DotNetObjectReference.Create(this);

        await JS.InvokeVoidAsync(
            "razorConsoleTerminal.init",
            targetId,
            new
            {
                convertEol = true,
                disableStdin = false,
                allowTransparency = false,
                theme = new
                {
                    background = "#1e1e1e",
                    foreground = "#d4d4d4"
                },
                fontFamily = "Consolas, \"Courier New\", monospace",
                fontSize = 14,
                lineHeight = 1.2,
                cursorBlink = false,
                scrollback = 1000,
                rows = 20,
                cols = 80
            }).ConfigureAwait(false);

        await JS.InvokeVoidAsync(
            "razorConsoleTerminal.attachKeyListener",
            targetId,
            _dotnetHelper).ConfigureAwait(false);

        var initial = await _renderer.RenderAsync().ConfigureAwait(false);
        if (!string.IsNullOrEmpty(initial))
        {
            await JS.InvokeVoidAsync("razorConsoleTerminal.write", targetId, initial)
                .ConfigureAwait(false);
        }

        _initialized = true;
    }

    [JSInvokable]
    public async Task HandleKeyboardEvent(string xtermKey, string domKey, bool ctrlKey, bool altKey, bool shiftKey)
    {
        if (_renderer is null)
        {
            return;
        }

        await _renderer.HandleKeyboardEventAsync(xtermKey, domKey, ctrlKey, altKey, shiftKey)
            .ConfigureAwait(false);
    }

    private void HandleSnapshotRendered(string content)
    {
        if (string.IsNullOrEmpty(content))
        {
            return;
        }

        _ = InvokeAsync(async () =>
        {
            await JS.InvokeVoidAsync("razorConsoleTerminal.write", EffectiveTerminalId, content)
                .ConfigureAwait(false);
        });
    }

    public void Dispose()
    {
        if (_renderer is not null)
        {
            _renderer.SnapshotRendered -= HandleSnapshotRendered;
            _renderer = null;
        }

        _dotnetHelper?.Dispose();
        _dotnetHelper = null;

        if (_initialized)
        {
            _ = JS.InvokeVoidAsync("razorConsoleTerminal.dispose", EffectiveTerminalId);
        }
    }
}
