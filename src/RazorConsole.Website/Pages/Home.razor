@page "/"
@using RazorConsole.Website.RazorConsoleComponents
@inject IJSRuntime JS
@implements IDisposable

<PageTitle>Razor Console</PageTitle>

<h1>Razor Console Preview</h1>

<div class="terminal-wrapper">
	<div id="@TerminalElementId"></div>
</div>

@code {
	private const string TerminalElementId = "console-terminal";
	private RazorConsoleRenderer<Counter>? _renderer;
	private DotNetObjectReference<Home>? _dotnetHelper;

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (!firstRender)
		{
			return;
		}

		await JS.InvokeVoidAsync("razorConsoleTerminal.init", TerminalElementId);

		_renderer = new RazorConsoleRenderer<Counter>();
		_renderer.SnapshotRendered += HandleSnapshotRendered;

		_dotnetHelper = DotNetObjectReference.Create(this);
		await JS.InvokeVoidAsync("razorConsoleTerminal.attachKeyListener", TerminalElementId, _dotnetHelper);

		var initial = await _renderer.RenderAsync();
		if (!string.IsNullOrEmpty(initial))
		{
			await JS.InvokeVoidAsync("razorConsoleTerminal.write", TerminalElementId, initial);
		}
	}

	[JSInvokable]
	public async Task HandleKeyboardEvent(string xtermKey, string domKey, bool ctrlKey, bool altKey, bool shiftKey)
	{
		if (_renderer is null)
		{
			return;
		}

		await _renderer.HandleKeyboardEventAsync(xtermKey, domKey, ctrlKey, altKey, shiftKey);
	}

	private void HandleSnapshotRendered(string content)
	{
		if (string.IsNullOrEmpty(content))
		{
			return;
		}

		_ = InvokeAsync(async () =>
		{
			await JS.InvokeVoidAsync("razorConsoleTerminal.write", TerminalElementId, content);
		});
	}

	public void Dispose()
	{
		if (_renderer is not null)
		{
			_renderer.SnapshotRendered -= HandleSnapshotRendered;
			_renderer = null;
		}

		_dotnetHelper?.Dispose();
		_ = JS.InvokeVoidAsync("razorConsoleTerminal.dispose", TerminalElementId);
	}
}
